# ระบบจับคู่ตำแหน่งอัตโนมัติ (Auto-Assign System)

## ภาพรวม

ระบบจับคู่ตำแหน่งอัตโนมัติช่วยให้สามารถจับคู่ผู้ยื่นขอตำแหน่งกับตำแหน่งว่างได้อย่างอัตโนมัติ โดยเรียงลำดับตาม `display_order` ที่กำหนดไว้

## วิธีการทำงาน

### 1. การเตรียมข้อมูล
- ผู้ยื่นขอตำแหน่งต้องมีการระบุ `requestedPositionId` (ตำแหน่งที่ขอ)
- ต้องมีการกำหนด `displayOrder` สำหรับการจัดลำดับความสำคัญ
- ตำแหน่งว่างคือตำแหน่งที่ไม่มี `fullName` หรือ `nationalId`

### 2. อัลกอริทึมการจับคู่
1. **ดึงข้อมูลผู้สมัคร**: เรียงลำดับตาม `displayOrder` (น้อยไปมาก)
2. **ดึงตำแหน่งว่าง**: จัดกลุ่มตาม `posCodeId`
3. **จับคู่**: วนลูปผู้สมัครตามลำดับ แล้วจับคู่กับตำแหน่งว่างแรกที่พบ

### 3. ผลลัพธ์
- **Assignments**: รายการที่จับคู่สำเร็จ
- **Unassigned**: รายการที่ไม่สามารถจับคู่ได้ (ไม่มีตำแหน่งว่าง)
- **Remaining Positions**: ตำแหน่งว่างที่เหลือ

## API Endpoints

### GET `/api/vacant-position/auto-assign`
ดูข้อมูลสถิติและตัวอย่างการจับคู่

**Parameters:**
- `year`: ปี พ.ศ. (required)

**Response:**
```json
{
  "year": 2568,
  "summary": {
    "totalApplicants": 15,
    "totalVacantPositions": 20,
    "positionStats": [...]
  },
  "applicants": [...]
}
```

### POST `/api/vacant-position/auto-assign`
ทำการจับคู่อัตโนมัติ

**Body:**
```json
{
  "year": 2568
}
```

**Response:**
```json
{
  "success": true,
  "year": 2568,
  "summary": {
    "totalApplicants": 15,
    "totalAssignments": 12,
    "totalUnassigned": 3,
    "totalRemainingVacant": 8
  },
  "assignments": [...],
  "unassigned": [...],
  "remainingVacantPositions": [...]
}
```

## หน้าจอผู้ใช้

### หน้าหลัก: `/police-personnel/vacant-position/auto-assign`

#### ฟีเจอร์หลัก:
1. **สถิติรวม**: แสดงจำนวนผู้สมัคร, ตำแหน่งว่าง, และการจับคู่ที่เป็นไปได้
2. **ตารางสถิติ**: แสดงข้อมูลแยกตามประเภทตำแหน่ง
3. **ปุ่มจับคู่**: เริ่มการจับคู่อัตโนมัติ
4. **ผลลัพธ์**: แสดงผลการจับคู่ในรูปแบบตาราง
5. **ส่งออกข้อมูล**: ดาวน์โหลดผลลัพธ์เป็นไฟล์ CSV

## การใช้งาน

### ขั้นตอนที่ 1: เตรียมข้อมูล
1. เข้าไปที่หน้า "รายการยื่นขอตำแหน่ง"
2. ตรวจสอบให้แน่ใจว่าผู้สมัครมีการระบุ "ตำแหน่งที่ขอ"
3. จัดลำดับ `displayOrder` ตามความสำคัญ (ลากและวาง)

### ขั้นตอนที่ 2: ดูสถิติ
1. เข้าไปที่หน้า "จับคู่ตำแหน่งอัตโนมัติ"
2. เลือกปี พ.ศ. ที่ต้องการ
3. ดูสถิติการจับคู่ที่เป็นไปได้

### ขั้นตอนที่ 3: จับคู่
1. คลิกปุ่ม "เริ่มจับคู่อัตโนมัติ"
2. ยืนยันการทำงาน
3. รอผลลัพธ์

### ขั้นตอนที่ 4: ตรวจสอบผลลัพธ์
1. ดูรายการที่จับคู่สำเร็จ
2. ตรวจสอบรายการที่ไม่สามารถจับคู่ได้
3. ส่งออกผลลัพธ์เป็นไฟล์ CSV

## ข้อควรระวัง

1. **การเรียงลำดับ**: `displayOrder` ที่น้อยกว่าจะได้รับการพิจารณาก่อน
2. **ตำแหน่งว่าง**: ระบบจะตรวจสอบจากตาราง `police_personnel` ที่ไม่มี `fullName` หรือ `nationalId`
3. **การจับคู่**: เป็นแบบ First Come First Serve ตามลำดับ `displayOrder`
4. **ข้อมูลย้อนหลัง**: การจับคู่ไม่มีผลต่อข้อมูลในฐานข้อมูล (เป็นเพียงการแสดงผลเท่านั้น)

## โครงสร้างไฟล์

```
src/app/
├── api/vacant-position/auto-assign/
│   └── route.ts                    # API endpoints
└── police-personnel/vacant-position/
    ├── page.tsx                    # หน้าหลัก (มีปุ่มลิงก์)
    └── auto-assign/
        └── page.tsx                # หน้าจับคู่อัตโนมัติ
```

## การพัฒนาต่อ

### ฟีเจอร์ที่อาจเพิ่มในอนาคต:
1. **บันทึกผลลัพธ์**: บันทึกการจับคู่ลงฐานข้อมูล
2. **ยกเลิกการจับคู่**: สามารถยกเลิกและจับคู่ใหม่ได้
3. **กฎการจับคู่แบบกำหนดเอง**: กำหนดเงื่อนไขการจับคู่เพิ่มเติม
4. **ประวัติการจับคู่**: เก็บประวัติการจับคู่แต่ละครั้ง
5. **การแจ้งเตือน**: แจ้งเตือนผลการจับคู่ผ่านอีเมล

## การแก้ไขปัญหา

### ปัญหาที่พบบ่อย:

1. **ไม่มีผู้สมัคร**: ตรวจสอบว่ามีการระบุ `requestedPositionId` หรือไม่
2. **ไม่มีตำแหน่งว่าง**: ตรวจสอบข้อมูลใน `police_personnel`
3. **การจับคู่ไม่ถูกต้อง**: ตรวจสอบ `displayOrder` และ `posCodeId`
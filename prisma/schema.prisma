// Prisma schema for NextAuth with MySQL (db: test_db)
// Adjust provider and connection via .env

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int       @id @default(autoincrement())
  username  String    @unique
  email     String?   @unique
  password  String
  firstName String?
  lastName  String?
  role      String    @default("user")
  isActive  Boolean   @default(true)
  lastLogin DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// POS Code Master (ข้อมูล Master รหัสตำแหน่ง)
model PosCodeMaster {
  id        Int      @id @map("pos_code_id") // รหัสตำแหน่ง
  name      String   @map("pos_code_name") // ชื่อตำแหน่ง
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  personnel                    PolicePersonnel[]
  swapTransactionDetails       SwapTransactionDetail[]
  swapLists                    SwapList[]
  vacantPositionsCurrent       VacantPosition[]      @relation("CurrentPosition")
  vacantPositionsRequested     VacantPosition[]      @relation("RequestedPosition")

  @@map("pos_code_master")
}

// Police Personnel Data (ข้อมูลตำแหน่งตำรวจ)
// ระบบนี้จัดเก็บข้อมูลตำแหน่ง ไม่ใช่ข้อมูลบุคคล
// - ตำแหน่งที่มีคนดำรง: มีชื่อ-สกุล + เลขบัตรประชาชน
// - รายการยื่นขอตำแหน่ง: มีข้อมูลตำแหน่ง แต่ไม่มีชื่อคน
model PolicePersonnel {
  id             String         @id @default(cuid())
  noId           Int?           @map("no_id")
  // ข้อมูลตำแหน่ง (Position Information)
  posCodeId      Int?           @map("pos_code") // รหัสตำแหน่ง (FK to PosCodeMaster)
  posCodeMaster  PosCodeMaster? @relation(fields: [posCodeId], references: [id])
  position       String? // ตำแหน่ง
  positionNumber String?        @map("position_number") // เลขตำแหน่ง
  unit           String? // หน่วย
  actingAs       String?        @map("acting_as") // ทำหน้าที่

  // ข้อมูลบุคคลที่ดำรงตำแหน่ง (Person Information - Optional for vacant positions)
  seniority  String? @map("seniority") // อาวุโส
  rank       String? // ยศ
  fullName   String? @map("full_name") // ชื่อสกุล (optional - ว่างถ้าไม่มีคนดำรง)
  nationalId String? @map("national_id") // เลขบัตรประชาชน (optional)
  birthDate  String? @map("birth_date") // วันเกิด
  age        String? // อายุ
  education  String? // คุณวุฒิ

  // ข้อมูลการแต่งตั้ง/ดำรงตำแหน่ง (Appointment Information)
  lastAppointment  String? @map("last_appointment") // แต่งตั้งครั้งสุดท้าย
  currentRankSince String? @map("current_rank_since") // ระดับนี้เมื่อ
  enrollmentDate   String? @map("enrollment_date") // บรรจุ
  retirementDate   String? @map("retirement_date") // เกษียณ
  yearsOfService   String? @map("years_of_service") // จำนวนปี

  // ข้อมูลการฝึกอบรม (Training Information)
  trainingLocation String? @map("training_location") // ตท. (ตำแหน่งการฝึกอบรม)
  trainingCourse   String? @map("training_course") // นรต. (นายร้อยตำรวจ)

  // หมายเหตุ
  notes String? @db.Text // หมายเหตุ/เงื่อนไข

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by") // ผู้สร้างข้อมูล
  updatedBy String?  @map("updated_by") // ผู้แก้ไขข้อมูล

  @@index([posCodeId])
  @@index([nationalId])
  @@index([rank])
  @@index([unit])
  @@index([position])
  @@map("police_personnel")
}

// Swap List (รายการที่เลือกไว้สำหรับสลับตำแหน่ง)
// เก็บสำเนาข้อมูลบุคลากรทั้งหมดไว้ เพราะ police_personnel มีการนำเข้าใหม่ทุกปีและข้อมูลเดิมจะถูกลบ
// ดังนั้นต้องเก็บ snapshot ของข้อมูลในขณะที่เพิ่มเข้า swap list
// รองรับทั้ง two-way, three-way, และ vacant-position
model SwapList {
  id       String @id @default(cuid())
  year     Int // ปีที่เลือก (พ.ศ.)
  swapType String @default("two-way") @map("swap_type") // two-way, three-way, vacant-position
  notes    String? @db.Text // หมายเหตุเพิ่มเติมสำหรับการ swap

  // ข้อมูลอ้างอิง
  noId Int? @map("no_id") // ลำดับที่

  // ข้อมูลตำแหน่ง (Position Information) - สำเนาจาก PolicePersonnel
  posCodeId      Int?           @map("pos_code")
  posCodeMaster  PosCodeMaster? @relation(fields: [posCodeId], references: [id])
  position       String? // ตำแหน่ง
  positionNumber String? @map("position_number") // เลขตำแหน่ง
  unit           String? // หน่วย
  actingAs       String? @map("acting_as") // ทำหน้าที่

  // ข้อมูลบุคคล (Person Information)
  seniority  String? @map("seniority") // อาวุโส
  rank       String? // ยศ
  fullName   String? @map("full_name") // ชื่อสกุล
  nationalId String? @map("national_id") // เลขบัตรประชาชน
  birthDate  String? @map("birth_date") // วันเกิด
  age        String? // อายุ
  education  String? // คุณวุฒิ

  // ข้อมูลการแต่งตั้ง/ดำรงตำแหน่ง (Appointment Information)
  lastAppointment  String? @map("last_appointment")
  currentRankSince String? @map("current_rank_since")
  enrollmentDate   String? @map("enrollment_date")
  retirementDate   String? @map("retirement_date")
  yearsOfService   String? @map("years_of_service")

  // ข้อมูลการฝึกอบรม (Training Information)
  trainingLocation String? @map("training_location")
  trainingCourse   String? @map("training_course")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by") // ผู้เพิ่มเข้า swap list
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by")

  // Index สำหรับการค้นหา
  @@index([year])
  @@index([swapType])
  @@index([nationalId])
  @@index([rank])
  @@index([unit])
  @@index([position])
  @@index([fullName])
  @@index([posCodeId])
  @@map("swap_list")
}

// Vacant Position List (รายการรายการยื่นขอตำแหน่ง)
// เก็บข้อมูลตำแหน่งที่ว่างไว้สำหรับการจัดการ
model VacantPosition {
  id    String @id @default(cuid())
  year  Int // ปีที่เลือก (พ.ศ.)
  notes String? @db.Text // หมายเหตุเพิ่มเติม
  displayOrder Int? @map("display_order") // ลำดับการแสดงผล (สำหรับ drag & drop)

  // ข้อมูลการเสนอชื่อเข้ารายการยื่นขอตำแหน่ง
  nominator              String? // ผู้สนับสนุน/ผู้เสนอชื่อ
  requestedPosition      String? @map("requested_position") // ตำแหน่งที่ขอ (text - deprecated)
  requestedPositionId    Int?    @map("requested_position_id") // รหัสตำแหน่งที่ขอ (FK to PosCodeMaster)
  requestedPosCode       PosCodeMaster? @relation("RequestedPosition", fields: [requestedPositionId], references: [id])

  // ข้อมูลอ้างอิง
  noId Int? @map("no_id") // ลำดับที่

  // ข้อมูลตำแหน่ง (Position Information)
  posCodeId      Int?           @map("pos_code")
  posCodeMaster  PosCodeMaster? @relation("CurrentPosition", fields: [posCodeId], references: [id])
  position       String? // ตำแหน่ง
  positionNumber String? @map("position_number") // เลขตำแหน่ง
  unit           String? // หน่วย
  actingAs       String? @map("acting_as") // ทำหน้าที่

  // ข้อมูลบุคคล (Person Information) - จะว่างส่วนใหญ่เพราะเป็นรายการยื่นขอตำแหน่ง
  seniority  String? @map("seniority")
  rank       String?
  fullName   String? @map("full_name")
  nationalId String? @map("national_id")
  birthDate  String? @map("birth_date")
  age        String?
  education  String?

  // ข้อมูลการแต่งตั้ง/ดำรงตำแหน่ง (Appointment Information)
  lastAppointment  String? @map("last_appointment")
  currentRankSince String? @map("current_rank_since")
  enrollmentDate   String? @map("enrollment_date")
  retirementDate   String? @map("retirement_date")
  yearsOfService   String? @map("years_of_service")

  // ข้อมูลการฝึกอบรม (Training Information)
  trainingLocation String? @map("training_location")
  trainingCourse   String? @map("training_course")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by")

  // Index
  @@index([year])
  @@index([unit])
  @@index([position])
  @@index([posCodeId])
  @@index([requestedPositionId])
  @@map("vacant_position")
}

// Swap Transaction (บันทึกผลการสลับตำแหน่งที่เสร็จสมบูรณ์แล้ว)
// เก็บข้อมูลการสลับตำแหน่งระหว่างบุคคล 2 คนขึ้นไป แต่ละ transaction คือการสลับตำแหน่งหนึ่งครั้ง
model SwapTransaction {
  id               String   @id @default(cuid())
  year             Int // ปีที่ทำการสลับ (พ.ศ.)
  swapDate         DateTime // วันที่ทำการสลับ
  swapType         String   @default("two-way") // two-way, three-way, multi-way
  groupName        String?  @map("group_name") // ชื่อกลุ่ม เช่น "นาย A ⟷ นาย B"
  groupNumber      String?  @map("group_number") // เลขกลุ่ม เช่น "2568/001"
  status           String   @default("completed") // completed, pending, cancelled
  notes            String?  @db.Text // หมายเหตุ
  
  // Relations
  swapDetails SwapTransactionDetail[]
  
  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by")

  @@index([year])
  @@index([swapDate])
  @@index([status])
  @@map("swap_transaction")
}

// Swap Transaction Detail (รายละเอียดการสลับของแต่ละคน)
// เก็บข้อมูลว่าใครย้ายจากตำแหน่งไหนไปตำแหน่งไหน
// รองรับทั้ง two-way และ three-way swap
model SwapTransactionDetail {
  id              String @id @default(cuid())
  transactionId   String @map("transaction_id")
  transaction     SwapTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  // ลำดับในวงจร (สำหรับ three-way: 1, 2, 3 / สำหรับ two-way: 1, 2)
  sequence        Int? // คนที่ 1, 2, 3, ... (optional สำหรับ two-way)
  
  // ข้อมูลบุคคล
  personnelId     String? @map("personnel_id") // ID อ้างอิงกับ police_personnel
  nationalId      String? @map("national_id") // เลขบัตรประชาชน
  fullName        String  @map("full_name") // ชื่อ-นามสกุล
  rank            String? // ยศ
  posCodeId       Int?    @map("pos_code_id") // รหัสตำแหน่ง
  posCodeMaster   PosCodeMaster? @relation(fields: [posCodeId], references: [id])
  
  // ตำแหน่งเดิม (From)
  fromPosition       String? @map("from_position") // ตำแหน่งเดิม
  fromPositionNumber String? @map("from_position_number") // เลขที่ตำแหน่งเดิม
  fromUnit           String? @map("from_unit") // หน่วยเดิม
  
  // ตำแหน่งใหม่ (To)
  toPosition         String? @map("to_position") // ตำแหน่งใหม่
  toPositionNumber   String? @map("to_position_number") // เลขที่ตำแหน่งใหม่
  toUnit             String? @map("to_unit") // หน่วยใหม่
  
  // ข้อมูลเพิ่มเติม
  notes              String? @db.Text // หมายเหตุเฉพาะคน
  
  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([transactionId])
  @@index([personnelId])
  @@index([nationalId])
  @@index([posCodeId])
  @@index([sequence])
  @@map("swap_transaction_detail")
}

// Prisma schema for NextAuth with MySQL (db: test_db)
// Adjust provider and connection via .env

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int       @id @default(autoincrement())
  username  String    @unique
  email     String?   @unique
  password  String
  firstName String?
  lastName  String?
  role      String    @default("user")
  isActive  Boolean   @default(true)
  lastLogin DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// POS Code Master (ข้อมูล Master รหัสตำแหน่ง)
model PosCodeMaster {
  id        Int      @id @map("pos_code_id") // รหัสตำแหน่ง
  name      String   @map("pos_code_name") // ชื่อตำแหน่ง
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  personnel                    PolicePersonnel[]
  swapTransactionDetailsFrom   SwapTransactionDetail[] @relation("FromPosition")
  swapTransactionDetailsTo     SwapTransactionDetail[] @relation("ToPosition")
  vacantPositions              VacantPosition[]        @relation("CurrentPosition")

  @@map("pos_code_master")
}

// Police Personnel Data (ข้อมูลตำแหน่งตำรวจ)
// ระบบนี้จัดเก็บข้อมูลตำแหน่ง ไม่ใช่ข้อมูลบุคคล
// - ตำแหน่งที่มีคนดำรง: มีชื่อ-สกุล + เลขบัตรประชาชน
// - รายการยื่นขอตำแหน่ง: มีข้อมูลตำแหน่ง แต่ไม่มีชื่อคน
model PolicePersonnel {
  id             String         @id @default(cuid())
  noId           Int?           @map("no_id")
  
  // ข้อมูลปี (Year & Status) - สำหรับเก็บข้อมูลประวัติข้ามปี
  year           Int            @default(2024) // ปีที่บันทึกข้อมูล (พ.ศ.)
  isActive       Boolean        @default(true) @map("is_active") // ข้อมูลปัจจุบันหรือไม่
  
  // ข้อมูลตำแหน่ง (Position Information)
  posCodeId      Int?           @map("pos_code") // รหัสตำแหน่ง (FK to PosCodeMaster)
  posCodeMaster  PosCodeMaster? @relation(fields: [posCodeId], references: [id])
  position       String? // ตำแหน่ง
  positionNumber String?        @map("position_number") // เลขตำแหน่ง
  unit           String? // หน่วย
  actingAs       String?        @map("acting_as") // ทำหน้าที่

  // ข้อมูลบุคคลที่ดำรงตำแหน่ง (Person Information - Optional for vacant positions)
  seniority  String? @map("seniority") // อาวุโส
  rank       String? // ยศ
  fullName   String? @map("full_name") // ชื่อสกุล (optional - ว่างถ้าไม่มีคนดำรง)
  nationalId String? @map("national_id") // เลขบัตรประชาชน (optional)
  birthDate  String? @map("birth_date") // วันเกิด
  age        String? // อายุ
  education  String? @db.Text // คุณวุฒิ - เปลี่ยนเป็น TEXT เพื่อรองรับข้อมูลยาว

  // ข้อมูลการแต่งตั้ง/ดำรงตำแหน่ง (Appointment Information)
  lastAppointment  String? @map("last_appointment") // แต่งตั้งครั้งสุดท้าย
  currentRankSince String? @map("current_rank_since") // ระดับนี้เมื่อ
  enrollmentDate   String? @map("enrollment_date") // บรรจุ
  retirementDate   String? @map("retirement_date") // เกษียณ
  yearsOfService   String? @map("years_of_service") // จำนวนปี

  // ข้อมูลการฝึกอบรม (Training Information)
  trainingLocation String? @map("training_location") // ตท. (ตำแหน่งการฝึกอบรม)
  trainingCourse   String? @map("training_course") // นรต. (นายร้อยตำรวจ)

  // หมายเหตุ
  notes String? @db.Text // หมายเหตุ/เงื่อนไข

  // ข้อมูลการเสนอชื่อ (Nomination Information)
  supporterName String? @map("supporter_name") // ผู้สนับสนุน/ผู้เสนอชื่อ
  supportReason String? @map("support_reason") @db.Text // เหตุผลในการสนับสนุน

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by") // ผู้สร้างข้อมูล
  updatedBy String?  @map("updated_by") // ผู้แก้ไขข้อมูล

  @@unique([nationalId, year], name: "nationalId_year") // UPSERT key: คนเดียวกันในปีเดียวกันต้องไม่ซ้ำ
  @@index([year])
  @@index([isActive])
  @@index([year, isActive])
  @@index([nationalId, year]) // สำหรับหาประวัติบุคคลข้ามปี
  @@index([posCodeId])
  @@index([nationalId])
  @@index([rank])
  @@index([unit])
  @@index([position])
  @@index([supporterName]) // Index for supporter search
  @@index([rank, posCodeId, fullName]) // Composite index for drawer query optimization
  @@index([unit, posCodeId, fullName]) // Composite index for unit filter with posCode
  @@map("police_personnel")
}

// Vacant Position List (snapshot ตำแหน่งว่างของแต่ละปี)
// เก็บข้อมูลตำแหน่งว่างเป็น snapshot ไว้สำหรับแสดงผล ไม่มี relationship กับ swap transaction
model VacantPosition {
  id    String @id @default(cuid())
  year  Int // ปีที่เลือก (พ.ศ.)
  notes String? @db.Text // หมายเหตุเพิ่มเติม

  // ข้อมูลอ้างอิง
  noId Int? @map("no_id") // ลำดับที่

  // ข้อมูลตำแหน่ง (Position Information)
  posCodeId      Int?           @map("pos_code")
  posCodeMaster  PosCodeMaster? @relation("CurrentPosition", fields: [posCodeId], references: [id])
  position       String? // ตำแหน่ง
  positionNumber String? @map("position_number") // เลขตำแหน่ง
  unit           String? // หน่วย
  actingAs       String? @map("acting_as") // ทำหน้าที่

  // ข้อมูลบุคคล (Person Information) - จะว่างส่วนใหญ่เพราะเป็นรายการยื่นขอตำแหน่ง
  seniority  String? @map("seniority")
  rank       String?
  fullName   String? @map("full_name")
  nationalId String? @map("national_id")
  birthDate  String? @map("birth_date")
  age        String?
  education  String? @db.Text // คุณวุฒิ - เปลี่ยนเป็น TEXT เพื่อรองรับข้อมูลยาว

  // ข้อมูลการแต่งตั้ง/ดำรงตำแหน่ง (Appointment Information)
  lastAppointment  String? @map("last_appointment")
  currentRankSince String? @map("current_rank_since")
  enrollmentDate   String? @map("enrollment_date")
  retirementDate   String? @map("retirement_date")
  yearsOfService   String? @map("years_of_service")

  // ข้อมูลการฝึกอบรม (Training Information)
  trainingLocation String? @map("training_location")
  trainingCourse   String? @map("training_course")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by")

  // Index
  @@index([year])
  @@index([unit])
  @@index([position])
  @@index([posCodeId])
  @@map("vacant_position")
}

// Swap Transaction (บันทึกผลการสลับตำแหน่งที่เสร็จสมบูรณ์แล้ว)
// เก็บข้อมูลการสลับตำแหน่งระหว่างบุคคล 2 คนขึ้นไป แต่ละ transaction คือการสลับตำแหน่งหนึ่งครั้ง
model SwapTransaction {
  id               String   @id @default(cuid())
  year             Int // ปีที่ทำการสลับ (พ.ศ.)
  swapDate         DateTime // วันที่ทำการสลับ
  swapType         String   @default("two-way") // two-way, three-way, multi-way
  groupName        String?  @map("group_name") // ชื่อกลุ่ม เช่น "นาย A ⟷ นาย B"
  groupNumber      String?  @map("group_number") // เลขกลุ่ม เช่น "2568/001"
  status           String   @default("completed") // completed, pending, cancelled
  notes            String?  @db.Text // หมายเหตุ
  
  // Relations
  swapDetails SwapTransactionDetail[]
  
  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String?  @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String?  @map("updated_by")

  @@index([year])
  @@index([swapDate])
  @@index([status])
  @@map("swap_transaction")
}

// Swap Transaction Detail (รายละเอียดการสลับของแต่ละคน)
// เก็บข้อมูลว่าใครย้ายจากตำแหน่งไหนไปตำแหน่งไหน
// รองรับทั้ง two-way และ three-way swap
model SwapTransactionDetail {
  id              String @id @default(cuid())
  transactionId   String @map("transaction_id")
  transaction     SwapTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  // ลำดับในวงจร (สำหรับ three-way: 1, 2, 3 / สำหรับ two-way: 1, 2)
  sequence        Int? // คนที่ 1, 2, 3, ... (optional สำหรับ two-way)
  
  // ข้อมูลบุคคล
  personnelId     String? @map("personnel_id") // ID อ้างอิงกับ police_personnel
  noId            Int?    @map("no_id") // ลำดับที่จาก police_personnel
  nationalId      String? @map("national_id") // เลขบัตรประชาชน
  fullName        String  @map("full_name") // ชื่อ-นามสกุล
  rank            String? // ยศ
  seniority       String? // อาวุโส
  posCodeId       Int?    @map("pos_code_id") // รหัสตำแหน่งเดิม (From Position)
  posCodeMaster   PosCodeMaster? @relation("FromPosition", fields: [posCodeId], references: [id])
  toPosCodeId     Int?    @map("to_pos_code_id") // รหัสตำแหน่งใหม่ (To Position)
  toPosCodeMaster PosCodeMaster? @relation("ToPosition", fields: [toPosCodeId], references: [id])
  
  // ข้อมูลส่วนตัว (Personal Information)
  birthDate       String? @map("birth_date") // วันเกิด
  age             String? // อายุ
  education       String? // คุณวุฒิ
  
  // ข้อมูลการแต่งตั้ง/ดำรงตำแหน่ง (Appointment Information)
  lastAppointment  String? @map("last_appointment") // แต่งตั้งครั้งสุดท้าย
  currentRankSince String? @map("current_rank_since") // ระดับนี้เมื่อ
  enrollmentDate   String? @map("enrollment_date") // บรรจุ
  retirementDate   String? @map("retirement_date") // เกษียณ
  yearsOfService   String? @map("years_of_service") // จำนวนปี
  
  // ข้อมูลการฝึกอบรม (Training Information)
  trainingLocation String? @map("training_location") // ตท. (ตำแหน่งการฝึกอบรม)
  trainingCourse   String? @map("training_course") // นรต. (นายร้อยตำรวจ)
  
  // ข้อมูลการเสนอชื่อ (Nomination Information) - Snapshot
  supportName      String? @map("support_name") // ผู้สนับสนุน/ผู้เสนอชื่อ (snapshot)
  supportReason    String? @map("support_reason") @db.Text // เหตุผลในการสนับสนุน (snapshot)
  
  // ตำแหน่งเดิม (From)
  fromPosition       String? @map("from_position") // ตำแหน่งเดิม
  fromPositionNumber String? @map("from_position_number") // เลขที่ตำแหน่งเดิม
  fromUnit           String? @map("from_unit") // หน่วยเดิม
  fromActingAs       String? @map("from_acting_as") // ทำหน้าที่ (ตำแหน่งเดิม)
  
  // ตำแหน่งใหม่ (To)
  toPosition         String? @map("to_position") // ตำแหน่งใหม่
  toPositionNumber   String? @map("to_position_number") // เลขที่ตำแหน่งใหม่
  toUnit             String? @map("to_unit") // หน่วยใหม่
  toActingAs         String? @map("to_acting_as") // ทำหน้าที่ (ตำแหน่งใหม่)
  
  // ข้อมูลเพิ่มเติม
  notes              String? @db.Text // หมายเหตุเฉพาะคน
  
  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([transactionId])
  @@index([personnelId])
  @@index([nationalId])
  @@index([posCodeId])
  @@index([sequence])
  @@map("swap_transaction_detail")
}

// Import Job (Background Job สำหรับ Import Personnel)
// ใช้สำหรับ track progress และ status ของการ import ข้อมูล
model ImportJob {
  id            String   @id @default(cuid())
  year          Int      // ปีที่ import
  importMode    String   @default("full") // full, supporter
  status        String   @default("pending") // pending, processing, completed, failed, cancelled
  
  // Progress tracking
  totalRows     Int      @default(0) // จำนวนแถวทั้งหมด
  processedRows Int      @default(0) // จำนวนแถวที่ประมวลผลแล้ว
  successRows   Int      @default(0) // จำนวนแถวที่สำเร็จ
  failedRows    Int      @default(0) // จำนวนแถวที่ล้มเหลว
  updatedRows   Int      @default(0) // จำนวนแถวที่ update (สำหรับ UPSERT mode)
  
  // File info
  fileName      String?  @map("file_name") // ชื่อไฟล์
  fileSize      Int?     @map("file_size") // ขนาดไฟล์ (bytes)
  
  // Error tracking
  errors        String?  @db.Text // JSON array ของ errors
  errorMessage  String?  @db.Text @map("error_message") // error message หลัก (ถ้า job fail)
  
  // Timestamps
  startedAt     DateTime? @map("started_at") // เวลาเริ่มประมวลผล
  completedAt   DateTime? @map("completed_at") // เวลาเสร็จสิ้น
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Audit
  createdBy     String?  @map("created_by") // ผู้สร้าง job
  
  @@index([status])
  @@index([year])
  @@index([createdAt])
  @@map("import_job")
}
